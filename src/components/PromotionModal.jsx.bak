import React, { useState, useEffect } from 'react'
import { motion } from 'framer-motion'
import { X } from 'lucide-react'
import { addDoc, collection, serverTimestamp, updateDoc, doc } from 'firebase/firestore'
import { db } from '../config/firebase'
import { useToast } from '../contexts/ToastContext'

export default function PromotionModal ({ isOpen, onClose, highStockProducts = [], popularProducts = [], currentUser, initialPromotion = null }) {
  const [selectedProductId, setSelectedProductId] = useState('')
  const [type, setType] = useState('discount') // 'discount' or 'bundle'
  const [discountPercent, setDiscountPercent] = useState(20)
  const [bundleProductId, setBundleProductId] = useState('')
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (isOpen && highStockProducts.length > 0) {
      setSelectedProductId(highStockProducts[0].id)
    }
    // If editing an existing promotion, prefill fields
    if (initialPromotion) {
      setSelectedProductId(initialPromotion.productId || '')
      setType(initialPromotion.type || 'discount')
      setDiscountPercent(initialPromotion.discountPercent || 20)
      setBundleProductId(initialPromotion.bundleWith || '')
    }
  }, [isOpen, highStockProducts, initialPromotion])

  const { showSuccess, showError, showWarning } = useToast()

  if (!isOpen) return null

  const handleSubmit = async () => {
    // Validation
  // Validation
  if (!selectedProductId) return showWarning('Pilih produk untuk dipromosikan')
  if (type === 'bundle' && !bundleProductId) return showWarning('Pilih produk untuk dibundling')
  if (type === 'discount' && (discountPercent <= 0 || discountPercent > 80)) {
    return showWarning('Persentase diskon harus antara 1% dan 80%')
  }
    if (type === 'discount' && (discountPercent <= 0 || discountPercent > 80)) {
      return showWarning('Persentase diskon harus antara 1% dan 80%')
    }

    setLoading(true)

    try {
      let ref
      const now = serverTimestamp()
      
      if (initialPromotion && initialPromotion.id) {
        // update existing promotion
        ref = { id: initialPromotion.id }
        await updateDoc(doc(db, 'promotions', initialPromotion.id), {
          productId: selectedProductId,
          type,
          discountPercent: type === 'discount' ? discountPercent : null,
          bundleWith: type === 'bundle' ? bundleProductId : null,
          updatedAt: now,
          status: 'active'
        })
      } else {
        const promotion = {
          userId: currentUser?.uid,
          productId: selectedProductId,
          type,
          createdAt: now,
          updatedAt: now,
          status: 'active',
          discountPercent: type === 'discount' ? discountPercent : null,
          bundleWith: type === 'bundle' ? bundleProductId : null
        }

      // Immediately update product documents so dashboard reflects promotion
      const selectedProduct = highStockProducts.find(p => p.id === selectedProductId)
      if (type === 'discount' && selectedProduct) {
        const salePrice = Math.round((selectedProduct.harga || 0) * (1 - discountPercent / 100))
        await updateDoc(doc(db, 'products', selectedProductId), {
          promo: {
            id: ref.id,
            type: 'discount',
            discountPercent,
            salePrice,
            active: true
          }
        })
      }

      if (type === 'bundle') {
        // set promo meta on both products (selected and bundle target) so dashboard can show bundle
        await updateDoc(doc(db, 'products', selectedProductId), {
          promo: {
            id: ref.id,
            type: 'bundle',
            bundleWith: bundleProductId,
            active: true
          }
        })

        // also tag the partner product
        await updateDoc(doc(db, 'products', bundleProductId), {
          promo: {
            id: ref.id,
            type: 'bundle',
            bundleWith: selectedProductId,
            active: true
          }
        })
      }

      showSuccess('Promosi berhasil dibuat. Anda dapat melihatnya di Dashboard Promosi.')
      onClose()
    } catch (error) {
      console.error('Error creating promotion:', error)
      showError('Gagal membuat promosi. Silakan coba lagi.')
    } finally {
      setLoading(false)
    }
  }

  // Filter popularProducts to exclude same product when bundling
  const availableBundleTargets = popularProducts.filter(p => p.id !== selectedProductId)

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 pb-20 sm:pb-4">
      <div className="absolute inset-0 bg-black opacity-40" onClick={onClose} />

      <motion.div
        initial={{ y: 200, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        className="relative bg-white rounded-2xl shadow-lg w-full max-w-lg p-4 mb-4 sm:mb-0"
      >
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-semibold text-lg">Buat Promosi</h3>
          <button onClick={onClose} className="text-gray-500"><X /></button>
        </div>

        <div className="space-y-3">
          <div>
            <label className="text-xs text-gray-500">Pilih produk (stok berlebih)</label>
            <select className="w-full input-field mt-1" value={selectedProductId} onChange={(e) => setSelectedProductId(e.target.value)}>
              {highStockProducts.map(p => (
                <option key={p.id} value={p.id}>{p.nama} â€” Stok: {p.stok}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="text-xs text-gray-500">Tipe Promosi</label>
            <div className="flex items-center gap-3 mt-2">
              <label className="flex items-center gap-2">
                <input type="radio" name="promoType" checked={type === 'discount'} onChange={() => setType('discount')} />
                Diskon
              </label>
              <label className="flex items-center gap-2">
                <input type="radio" name="promoType" checked={type === 'bundle'} onChange={() => setType('bundle')} />
                Bundling
              </label>
            </div>
          </div>

          {type === 'discount' && (
            <div>
              <label className="text-xs text-gray-500">Persentase Diskon (%)</label>
              <input type="number" min={1} max={80} value={discountPercent} onChange={e => setDiscountPercent(Number(e.target.value))} className="input-field mt-1" />
            </div>
          )}

          {type === 'bundle' && (
            <div>
              <label className="text-xs text-gray-500">Pilih produk untuk dibundling (jangan pilih produk yang sama)</label>
              <select className="w-full input-field mt-1" value={bundleProductId} onChange={e => setBundleProductId(e.target.value)}>
                <option value="">-- Pilih produk --</option>
                {availableBundleTargets.map(p => (
                  <option key={p.id} value={p.id}>{p.nama}</option>
                ))}
              </select>
            </div>
          )}

          <div className="flex items-center justify-end gap-3 pt-2">
            <button onClick={onClose} className="btn-secondary">Batal</button>
            <button onClick={handleSubmit} disabled={loading} className="btn-primary">
              {loading ? 'Menyimpan...' : 'Terapkan Promosi'}
            </button>
          </div>
        </div>
      </motion.div>
    </div>
  )
}
